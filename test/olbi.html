<html>

<head>
  <link rel="icon" href="data:,">
  <script src="../olbi.js"></script>
  <style>
    html {
      font-size: 12px;
      font-family: "Lucida Console", Monaco, monospace;
    }

    th,
    td,
    div,
    span {
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <script>
    // Reference: https://qiita.com/saekis/items/c2b41cd8940923863791 
    function escape_html(string) {
      if (typeof string !== 'string') {
        return string;
      }
      return string.replace(/[&'`"<>]/g, function (match) {
        return {
          '&': '&amp;',
          "'": '&#x27;',
          '`': '&#x60;',
          '"': '&quot;',
          '<': '&lt;',
          '>': '&gt;',
        }[match]
      });
    }

    function unionOuterHTML(elements) {
      let s = "";
      for (let i = 0; i < elements.length; ++i) {
        s += elements[i].outerHTML.replace(/(\r|\n)\s+/g, "");
      }
      return s;
    }

    let no = 0;

    function test(title, expected, actual) {
      ++no;
      let actual2;
      if (typeof actual === 'function') {
        actual2 = actual();
      } else {
        actual2 = actual;
      }
      const result = expected === actual2;

      document.querySelector(".status").insertAdjacentHTML("beforeend",
        "<td>" + no + "</td>" +
        "<td style='background-color:" + (result ? "LightGreen" : "LightCoral") + ";'>" + (result ? "OK" : "NG") +
        "</td>" +
        "<td>" + title + "</td>" +
        "<td>" +
        "<div><span>E </span><span>" + escape_html(expected) + "</span></div>" +
        "<div><span>A </span><span>" + escape_html(actual2) + "</span></div>" +
        "</td>" +
        "");
    }
  </script>
  <div>
    <h1>Tests</h1>
    <h2>Status</h2>
    <div>
      <table>
        <thead>
          <th>#</th>
          <th>Result</th>
          <th>Title</th>
          <th>Expected/Actual</th>
        </thead>
        <tbody class="status">

        </tbody>
      </table>
    </div>
    <h2>Bench</h2>
    <div class="bench">

      <div class="olbi.primitiveToText">
        <div class="primitiveToText"></div>
      </div>

      <div class="olbi.primitiveWithValue">
        <input name="primitiveWithValue" type="text">
      </div>

      <div class="array2">
        <div class="array2-item"></div>
      </div>

      <div class="array1">
        <div class="array1-item"></div>
      </div>

      <div class="object">
        <div class="primitive appending">div1</div>
      </div>

      <div class="link">
        <div>div1</div>
        <div>div2</div>
      </div>

    </div>
  </div>
  <script>
    window.onload = function () {

      Olbi.configure({ traceLink: true });

      test(
        "olbi.primitiveToText",
        'value',
        function () {
          var olbi = new Olbi({
            "primitiveToText": "",
          });
          olbi
            .primitiveToText.toText().traceLink()
            .setData({
              "primitiveToText": "value",
            });

          return document.querySelector(".primitiveToText").textContent;
        }
      );

      test(
        "olbi.primitiveWithValue",
        'value',
        function () {
          var olbi = new Olbi({
            "primitiveWithValue": "",
          });
          olbi
            .primitiveWithValue.withValue().traceLink()
            .setData({
              "primitiveWithValue": "value",
            });

          return document.querySelector("[name='primitiveWithValue']").value;
        }
      );

      test(
        "olbi.array2.each",
        '[{"templateSets":[{"target":"array2","template":"array2-item","xlbi":{}}]}]',
        function () {
          var olbi = new Olbi({
            "array2": [
              ""
            ]
          });
          olbi.array2.each(function () {

          })
            .setData(["apple"])
            ;

          var eachSets = olbi.array2.___r.eachSets;
          eachSets[0].templateSets[0].target = eachSets[0].templateSets[0].target.className;
          eachSets[0].templateSets[0].template = eachSets[0].templateSets[0].template.className;

          return JSON.stringify(olbi.array2.___r.eachSets);
        }
      );

      test(
        "olbi.array1.each",
        '[{"templateSets":[{"target":"array1","template":"array1-item","xlbi":null}]}]',
        function () {
          var olbi = new Olbi({
            "array1": [
              ""
            ]
          });
          olbi.array1.each(function () {

          });

          var eachSets = olbi.array1.___r.eachSets;
          eachSets[0].templateSets[0].target = eachSets[0].templateSets[0].target.className;
          eachSets[0].templateSets[0].template = eachSets[0].templateSets[0].template.className;

          return JSON.stringify(olbi.array1.___r.eachSets);
        }
      );

      test(
        "Olbi.object.primitive.preferredLink",
        '<div class="primitive appending">div1</div>',
        function () {
          var olbi = new Olbi({
            "object": {
              "primitive": "",
            },
          });
          return unionOuterHTML(olbi.object.primitive.preferredLink(Olbi.preferreds.DOWN_AND_CLASS, ".appending").elemCollection);
        }
      );

      test(
        "Olbi.object.primitive.fullPreferredSelector",
        ".object [name='primitive'].appending",
        function () {
          var olbi = new Olbi({
            "object": {
              "primitive": "",
            },
          });
          return olbi.object.primitive.fullPreferredSelector(Olbi.preferreds.DOWN_AND_NAME, ".appending");
        }
      );

      test(
        "Olbi.object.primitive.preferredSelector",
        ".primitive.appending",
        function () {
          var olbi = new Olbi({
            "object": {
              "primitive": "",
            },
          });
          return olbi.object.primitive.preferredSelector(Olbi.preferreds.CLASS, ".appending");
        }
      );

      test(
        "Olbi.object.preferredSelector",
        ".object.appending",
        function () {
          var olbi = new Olbi({
            "object": {
            },
          });
          return olbi.object.preferredSelector(Olbi.preferreds.CLASS, ".appending");
        }
      );

      test(
        "Olbi.link",
        "<div>div1</div><div>div2</div>",
        function () {
          return unionOuterHTML((new Olbi({})).link(".link>div").elemCollection);
        }
      );

      test(
        "objectAssignDeep",
        JSON.stringify({
          "ppp": "PPP",
          object: {
            "aaa": "AAA"
          },
          items: [
            "a",
            "b",
          ]
        }),
        function () {
          return JSON.stringify(Olbi.objectAssignDeep({
            "ppp": "P3",
            object: {
              "aaa": "A3"
            },
            items: [
              "a",
            ]
          }, {
              "ppp": "PPP",
              object: {
                "aaa": "AAA"
              },
              items: [
                "b",
              ]
            }));
        }
      );


    };
  </script>
</body>

</html>